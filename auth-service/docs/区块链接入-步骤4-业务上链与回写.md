# 步骤 4：业务上链与回写（细化版）

**前提**：步骤 1～3 已完成（链、证书、合约地址、SDK 连链均就绪）。

**目标**：在「身份注册」与「审计日志写入」时自动调用步骤 2 部署的存证合约，并将交易哈希、区块号回写到库表。

---

## 第一部分：实现说明（已实现）

### 4.1 存证合约封装

- **`com.test.blockchain.EvidenceStorageContract`**
  - 对应合约：`contracts/EvidenceStorage.sol`。
  - 提供静态方法：`set(web3j, credentials, gasProvider, contractAddress, key, hash)`、`get(...)`，用于写入与查询链上存证。

### 4.2 链上存证服务

- **`com.test.blockchain.ChainEvidenceService`**（接口）
  - 方法：`EvidenceResult saveEvidence(String key, String hash)`。
  - 返回：成功时带 `transactionHash`、`blockNumber`；未上链或失败时返回 `null`。

- **`com.test.blockchain.ChainEvidenceServiceImpl`**
  - 当 `fisco.enabled=true` 且已配置 `fisco.evidence-contract-address` 时，调用 `EvidenceStorageContract.set` 上链，并返回回执中的 txHash、blockNumber。

- **`com.test.blockchain.ChainEvidenceServiceNoOp`**
  - 当未启用区块链时注入此实现，不执行上链，`saveEvidence` 恒返回 `null`。

### 4.3 业务接入

- **身份注册（IdentityServiceImpl.register）**
  - 插入 `did_identity` 后，用 DID + 身份字段生成摘要并做 SHA256，作为 `hash`。
  - 调用 `chainEvidenceService.saveEvidence(identity.getDid(), hash)`。
  - 若返回值非 null，将 `transactionHash`、`blockNumber` 写入当前身份的 `chain_tx_hash`、`chain_block_number` 并 updateById。

- **审计日志（AuditLogServiceImpl.save）**
  - 插入 `audit_log` 后，用操作类型、目标 DID、详情、时间等生成摘要并做 SHA256，作为 `hash`。
  - 调用 `chainEvidenceService.saveEvidence("audit_" + log.getId(), hash)`。
  - 若返回值非 null，将 `transactionHash`、`blockNumber` 写入该条日志的 `chain_tx_hash`、`chain_block_number` 并 updateById。

---

## 第二部分：配置与开关

- **关闭上链**：在 `application.properties` 中设置 `fisco.enabled=false`，则只写库、不连链、不回写链上字段。
- **不填合约地址**：若 `fisco.evidence-contract-address` 为空，链上存证不会执行，业务照常写库，链字段保持为空。

---

## 第三部分：验证建议

1. **身份注册**
   - 启用链且配置正确时，注册一条新身份。
   - 在库表 `did_identity` 中查看该记录的 `chain_tx_hash`、`chain_block_number` 是否有值。
   - 在 Console 中对该 DID 做 `get(DID)`，应能查到与业务一致的 hash。

2. **审计日志**
   - 执行一次权限修改或注销 DID，触发审计日志。
   - 在 `audit_log` 中查看对应记录的 `chain_tx_hash`、`chain_block_number`。
   - 在 Console 中对 `audit_<日志id>` 做 `get("audit_<id>")` 验证。

---

## 完成后自检

- [ ] 配置了 `fisco.evidence-contract-address` 且应用可连链。
- [ ] 新注册身份在库中有 `chain_tx_hash`、`chain_block_number`（或确认上链失败原因）。
- [ ] 新产生的审计日志在库中有链上回写（同上）。

完成以上即**步骤 4 结束**。后续可做步骤 5：前端展示交易哈希、区块号及链上验证入口（若需）。
