# 步骤 2：存证智能合约编写与部署（细化版）

**前提**：步骤 1 已完成（链信息与证书已拿到，证书已拷到本机 `conf/`）。

**目标**：在链上部署一个「key → hash」的存证合约，供后续身份注册、审计日志上链时写入并查询；本步骤完成后得到**合约地址**，步骤 3/4 会用到。

**需要记录的信息**：见文末「步骤 2 记录表」。

---

## 第一部分：准备合约源码

### 步骤 2.1 确认本机项目中的合约文件

**操作**：在本机项目中已提供存证合约源码：

```
auth-service/contracts/EvidenceStorage.sol
```

合约功能简要：

- `set(string key, string hash)`：写入一条存证（key 如 DID 或 `audit_日志id`，hash 为业务数据 hash）。
- `get(string key)`：根据 key 查询已存 hash。
- 事件 `SetRecord(key, hash)`：便于链上检索与验证。

**需要记录**：无需填写，仅确认该文件存在即可。

---

### 步骤 2.2 将合约拷到虚拟机的 Console 可编译目录

FISCO Console 通常从固定目录加载 `.sol` 文件进行编译和部署，请以你实际使用的 Console 文档为准。常见做法如下。

**操作一**：在虚拟机中查 Console 的合约目录（示例，路径按你实际安装改）：

```bash
# 若 Console 在 ~/fisco/console 或 /root/console 等
find ~ -name "console" -type d 2>/dev/null | head -5
ls ~/fisco/console/contracts
# 或
ls /root/console/contracts
```

**操作二**：在本机把 `auth-service/contracts/EvidenceStorage.sol` 复制到虚拟机该目录下。  
例如通过共享文件夹：本机复制 `EvidenceStorage.sol` → 虚拟机粘贴到 `~/fisco/console/contracts/`（或你查到的 `contracts` 目录）。

**需要记录**：虚拟机里合约所在目录的完整路径。  
→ 填到记录表 **【K】合约文件在虚拟机中的路径**。

---

## 第二部分：在虚拟机 Console 中编译并部署

### 步骤 2.3 启动 Console 并确认连接 group 1

**操作**：

```bash
cd ~/fisco/console
bash start.sh
```

看到类似 `[group:1]>` 即表示已连上群组 1。

**需要记录**：无需填写，确认出现 `[group:1]>` 即可。

---

### 步骤 2.4 编译合约

**操作**：在 Console 里执行（合约名与文件名一致，不含 .sol）：

```bash
deploy EvidenceStorage
```

若当前 Console 版本是「先编译再部署」两步，则先执行（以实际 Console 文档为准）：

```bash
compile EvidenceStorage.sol
```

再执行：

```bash
deploy EvidenceStorage
```

**可能情况**：

- 若提示找不到合约：检查 2.2 中 `EvidenceStorage.sol` 是否在 Console 的 `contracts` 目录下，且文件名一致。
- 若编译报错：确认 FISCO 节点与 Console 支持的 Solidity 版本；本合约为 `^0.4.25`，若需改版本再编译，可改 `EvidenceStorage.sol` 第一行后重新拷贝到虚拟机再执行。

**需要记录**：部署成功后会输出 **contract address**（以 0x 开头的十六进制）。  
→ 填到记录表 **【L】存证合约地址**。

---

### 步骤 2.5 验证合约可读写

**操作**：在 Console 中调用一次 set 和 get（把下面地址换成你在 2.4 得到的**合约地址**）：

```bash
call EvidenceStorage 0x57da04b46d73b64b77408d052570b16bceca5eb4 set "test_key" "abc123hash"
getBlockNumber
call EvidenceStorage 0x57da04b46d73b64b77408d052570b16bceca5eb4 get "test_key"
```

**预期**：set 后区块高度 +1；get 返回 `abc123hash`。

**需要记录**：若 get 能正确返回，说明合约工作正常。  
→ 在记录表 **【M】合约验证** 填「通过」。

---

## 第三部分：步骤 2 记录表（请填写并保存）

| 序号 | 项目 | 你的值（请填写） |
|------|------|------------------|
| **K** | 合约文件在虚拟机中的路径（如 ~/fisco/console/contracts） | |
| **L** | 存证合约地址（0x 开头，部署成功后输出） | |
| **M** | 合约验证（set/get 测试是否通过） | 通过 / 未通过 |

---

## 完成后自检

- [ ] `EvidenceStorage.sol` 已拷到虚拟机 Console 的 contracts 目录。
- [ ] Console 中已执行 `deploy EvidenceStorage` 并得到合约地址。
- [ ] 记录表 **【L】存证合约地址** 已填写。
- [ ] 已用 set/get 验证合约可用（【M】为「通过」）。

完成以上即**步骤 2 结束**。步骤 3 将在 auth-service 中引入 FISCO Java SDK、配置节点与证书，并调用该合约地址进行上链测试。
